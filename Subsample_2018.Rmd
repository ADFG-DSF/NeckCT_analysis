---
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
## copied from results.Rmd file, get catch data
library(lubridate)
library(magrittr)
e1_raw <- 
  readxl::read_xlsx(".\\Neck 2018 AWL Data Combined To Adam 12_17_18 CJS Edits 1_23_19.xlsx",
                    sheet = 3,
                    range = "A4:V182",
                    col_names = c("area", "trap", "gear", "rods", "date_set", "date_pull", "time_set", "time_pull", "depth",
                                  "effort0", "ct_large", "ct_small", "dv", "coho", "sculpin", "kok", "sb", "comment"),
                    col_types = c(rep("skip", 2), rep("text", 4), rep("date", 4), "text", rep("skip", 2), rep("numeric", 8), "text"))
hour(e1_raw$date_set) <- hour(e1_raw$time_set)
minute(e1_raw$date_set) <- minute(e1_raw$time_set)
hour(e1_raw$date_pull) <- hour(e1_raw$time_pull)
minute(e1_raw$date_pull) <- minute(e1_raw$time_pull)
e1 <- 
  e1_raw %>% 
  dplyr::mutate(rods = as.numeric(ifelse(rods == "NA", NA, rods)),
                gear = ifelse(is.na(rods), gear, "HL"),
                depth = as.numeric(ifelse(depth == "HL", NA, depth)),
                effort = ifelse(gear ==  "HL", 
                                difftime(date_pull, date_set, units = "mins") * rods,
                                difftime(date_pull, date_set, units = "mins")),
                check = effort - effort0,
                event = "mark"
  ) %>%
  dplyr::select(-trap, -time_set, -date_pull, -time_pull, -sculpin, -kok, -sb)

e2_raw <- 
  readxl::read_xlsx(".\\Neck 2018 AWL Data Combined To Adam 12_17_18 CJS Edits 1_23_19.xlsx",
                    sheet = 4,
                    range = "A4:U185",
                    col_names = c("area", "trap", "gear", "rods", "date_set", "date_pull", "time_set", "time_pull", "depth",
                                  "effort0", "ct_large", "ct_small", "dv", "coho", "sculpin", "kok", "sb", "comment"),
                    col_types = c(rep("skip", 2), rep("text", 4), rep("date", 4), "text", "skip", rep("numeric", 8), "text"))
hour(e2_raw$date_set) <- hour(e2_raw$time_set)
minute(e2_raw$date_set) <- minute(e2_raw$time_set)
hour(e2_raw$date_pull) <- hour(e2_raw$time_pull)
minute(e2_raw$date_pull) <- minute(e2_raw$time_pull)
e2 <- 
  e2_raw %>% 
  dplyr::mutate(rods = as.numeric(ifelse(rods == "NA", NA, rods)),
                gear = ifelse(is.na(rods), gear, "HL"),
                depth = as.numeric(ifelse(depth == "HL", NA, depth)),
                effort = ifelse(gear ==  "HL", 
                                difftime(date_pull, date_set, units = "mins") * rods,
                                difftime(date_pull, date_set, units = "mins")),
                check = effort - effort0,
                event = "recap"
  ) %>%
  dplyr::select(-trap, -time_set, -date_pull, -time_pull, -sculpin, -kok, -sb)

#minor chages, retain date of sample
e <-
  rbind(e1, e2) %>%
  dplyr::select(subarea = area, date_set, gear, depth, ct_large, ct_small, dv, coho, effort, event) %>%
  dplyr::left_join(data.frame(subarea = as.character(1:9), area = rep(LETTERS[1:3], each = 3), stringsAsFactors = FALSE), by = "subarea") %>%
  dplyr::mutate(date = as.Date(date_set, format = "%m-%d-%year")) %>%
  dplyr::select(-subarea, -date_set) %>%
  tidyr::gather(spp, n, -date, -area, -gear, -depth, -effort, -event) %>%
  dplyr::mutate(cpue = n / effort)

myboot <-
  function(dat, event, gear, spp){
    #dat2 <- dat$cpue[dat$event == event & dat$gear == gear & dat$spp == spp]
    dat2 <- dat$cpue[dat$gear == gear & dat$spp == spp]
    boot <- boot::boot(dat2, function(x, n){mean(x[n])}, 500)
    boot
    boot_ci <- boot::boot.ci(boot, type = "perc")
    data.frame(
      #event = event,
      gear = gear,
      spp = spp,
      mean = boot$t0,
      lci = boot_ci$perc[4],
      uci = boot_ci$perc[5]
    )
  }
grid <-
  expand.grid(#event = unique(e$event),
    gear = unique(e$gear),
    spp = unique(e$spp),
    stringsAsFactors = FALSE)

full_cpue <- #added name to obtain full data means and CIs
mapply(myboot,
       #event = grid$event,
       gear = grid$gear,
       spp = grid$spp,
       MoreArgs = list(dat = e),
       SIMPLIFY = FALSE,
       USE.NAMES = FALSE) %>%
  do.call(rbind, .)
## end of copied code

# all combinations of dates
dates <- combn(unique(e$date), 3, simplify = FALSE) # %>% sample(size = 1000, replace = FALSE)
# get mean for each date combination
test <- 
  lapply(dates, 
         function(x){
          mapply(myboot,
                 gear = grid[1:6,]$gear,
                 spp = grid[1:6,]$spp,
                 MoreArgs = list(dat = e[e$date %in% x, ]),
                 SIMPLIFY = FALSE,
                 USE.NAMES = FALSE) %>%
          do.call(rbind, .) %>%
          dplyr::select(mean)})
```

##CPUE
These histograms were generated by taking all 3 day combinations from the full data and recalculating mean CPUE for each size class and gear type with each reduced dataset. The thick black line represents the mean from the full data and the red lines represent the 95% CI for the full data. The variability in estimated CPUE under 3 days of sampling is substantial. This variability would decrease if more days were included in the reduced sample.
  
```{r, fig.height=10, fig.width=8, results = "hide"}
# make histograms with all mean cpue estimates and the mean and 95% CI from the full dataset as reference.
par(mfrow = c(3,2))
mapply(function(x, y1, y2, z1, z2, z3){
  hist(x, main = paste0(y1, "-",y2), breaks = 20)
  abline(v = z1, lwd = 4)
  abline(v = z2, lwd = 2, col = "red")
  abline(v = z3, lwd = 2, col = "red")},
  as.data.frame(t(do.call(cbind, test))), grid[1:6, 1], grid[1:6, 2], full_cpue[1:6, 3], full_cpue[1:6, 4], full_cpue[1:6, 5])
par(mfrow = c(1,1))
```

```{r}
##now for average length copied code
raw <- 
  readxl::read_xlsx(".\\Neck 2018 AWL Data Combined To Adam 12_17_18 CJS Edits 1_23_19.xlsx",
                    sheet = 1,
                    range = "A4:K2192",
                    col_names = c("date", "subarea", "depth", "trap", "gear", "fl", "tag", "clip", "comment"),
                    col_types = c(rep("skip", 2), "date", "numeric", rep("text", 7))) %>%
  dplyr::mutate(id = dplyr::row_number())

fl <- 
  raw %>% 
  dplyr::left_join(data.frame(subarea = 1:9, area = rep(LETTERS[1:3], each = 3)), by = "subarea") %>%
  dplyr::filter(tag != "NONE" && clip != "NONE") %>%
  dplyr::filter(tag != "second event recap") %>%
  dplyr::filter(clip != "NONE") %>%
  dplyr::mutate(event = ifelse(date < as.POSIXct("2018-06-15 UTC"), "mark", "recap"),
                date = as.Date(date, format = "%B%d"),
                depth = as.numeric(ifelse(depth == "HL", NA, depth)),
                fl = as.numeric(ifelse(fl ==  "RECAP", NA, fl)),
                comment = ifelse(tag == "second event recap", tag, comment),
                tag = as.numeric(ifelse(tag %in% c("Lost tag", "NA", "NONE", "second event recap"), NA, tag)),
                clip = ifelse(clip %in% c("NO", "NONE", "NA"), NA, clip),
                comment = ifelse(comment == "NA", NA, comment)
  ) %>%
  dplyr::select(-trap, -subarea)

mr0 <- 
  fl %>%
  dplyr::filter((fl >= 180 | is.na(fl)),
                !(comment == "Mort" & event == "mark" & is.na(tag))) %>%
  dplyr::mutate(n1 = ifelse(event == "mark", 1, 0),
                n2 = ifelse(event == "recap", 1, 0),
                m2 = ifelse(event == "recap" & !is.na(tag), 1, 0))
mr0$m2[which(mr0$comment == "lost floy tag")] <- 1

move <-
  mr0 %>% 
  dplyr::filter(!is.na(tag)) %>%
  dplyr::arrange(tag, event, date, area) %>% 
  dplyr::group_by(tag, event) %>% 
  dplyr::summarise(area2 = ifelse(length(area) == 1, LETTERS[area], paste0(area, collapse = "")))

tags <- 
  mr0 %>%
  dplyr::filter(!is.na(tag)) %>%
  dplyr::arrange(tag, event, date) %>%
  dplyr::select(tag, event, date) %>%
  dplyr::mutate(dup = 1)

mr <-
  dplyr::left_join(mr0, 
                   tags[duplicated(tags[, c("tag", "event")]), -which(colnames(tags) == "event")], 
                   by = c("tag", "date")) %>%
  dplyr::filter(is.na(dup))
## end copied code
```

##Mean length
I repeated the exercise two times with mean length (one for the marking event and once for the recapture event, because growth occurred between the events). Again, some of our mean length estimates from the reduced data fall outside of the 95% CI of the full data. The thing to notice is the range of estimates under the reduced data. For length, even extreme misses would represent errors of less than 10% in our estimate of mean length. Extreme misses in CPUE will represent errors of over 50%. A rapid assessment strategy that focused on length or length composition estimates is more likely to provide useful management advice.
  
```{r}
dates_mark <- combn(unique(fl$date[fl$event == "mark"]), 3, simplify = FALSE)
dates_recap <- combn(unique(fl$date[fl$event == "recap"]), 3, simplify = FALSE)
# get mean for each date combination
mean_mark <- sapply(dates_mark, function(x){mean(fl$fl[fl$date %in% x], na.rm = TRUE)})
hist(mean_mark, main = "Marking event", breaks = 20)
mu1 <- mean(fl$fl[fl$event == "mark"], na.rm = TRUE)
se1 <- sd(fl$fl[fl$event == "mark"], na.rm = TRUE)/sqrt(length(fl$fl[fl$event == "mark" & !is.na(fl$fl)]))
abline(v = mu1, lwd = 4)
abline(v = mu1 - 2*se1, lwd = 2, col = "red")
abline(v = mu1 + 2*se1, lwd = 2, col = "red")

mean_recap <- sapply(dates_recap, function(x){mean(fl$fl[fl$date %in% x], na.rm = TRUE)})
hist(mean_recap, main = "Recap event", breaks = 20)
mu2 <- mean(fl$fl[fl$event == "recap"], na.rm = TRUE)
se2 <- sd(fl$fl[fl$event == "recap"], na.rm = TRUE)/sqrt(length(fl$fl[fl$event == "recap" & !is.na(fl$fl)]))
abline(v = mu2, lwd = 4)
abline(v = mu2 - 2*se2, lwd = 2, col = "red")
abline(v = mu2 + 2*se2, lwd = 2, col = "red")
```
```{r, include = FALSE, results = FALSE}
# Same pattern for normal data
x <- data.frame(day <- rep(1:18, each=80), cpue = rnorm(1440))
x_samp <- combn(unique(x$day), 9, simplify = FALSE)
x_mu <- sapply(x_samp, function(y) mean(x$cpue[x$day %in% y]))
sum(x_mu <= -1.96/sqrt(1440) | x_mu >= 1.96/sqrt(1440))
hist(x_mu)

abline(v = 1.96*1/sqrt(1440))
abline(v = -1.96*1/sqrt(1440))
```